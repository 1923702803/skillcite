# 功能测试清单

## ✅ 服务器状态

开发服务器应该已经启动在：**http://localhost:3000**

## 📋 测试步骤

### 1. 基础功能测试

#### ✅ 访问主页
- [ ] 打开浏览器访问 `http://localhost:3000`
- [ ] 检查页面是否正常加载
- [ ] 检查是否自动跳转到登录页面（未登录用户）

#### ✅ 用户注册
- [ ] 访问 `http://localhost:3000/register`
- [ ] 填写注册表单：
  - 邮箱：`test@example.com`
  - 密码：`test123456`
  - 确认密码：`test123456`
- [ ] 点击"注册"
- [ ] 检查是否显示"注册成功"提示
- [ ] 检查是否自动跳转到登录页面

#### ✅ 用户登录
- [ ] 访问 `http://localhost:3000/login`
- [ ] 使用刚才注册的账号登录
- [ ] 检查是否成功登录并跳转到主页
- [ ] 检查右上角是否显示用户菜单

### 2. 使用次数功能测试

#### ✅ 检查初始使用次数
- [ ] 登录后，检查右上角是否显示"剩余: 3 次"
- [ ] 确认新用户默认有 3 次免费使用

#### ✅ 使用分析功能（消耗免费次数）
- [ ] 点击"分析"按钮
- [ ] 检查分析是否正常执行
- [ ] 检查右上角使用次数是否减少为"剩余: 2 次"
- [ ] 再次点击"分析"，检查是否减少为"剩余: 1 次"
- [ ] 第三次点击"分析"，检查是否减少为"剩余: 0 次"

#### ✅ 免费次数用尽测试
- [ ] 当剩余次数为 0 时，再次点击"分析"
- [ ] 检查是否显示提示："免费次数已用完！请升级会员以继续使用分析功能。"
- [ ] 检查是否自动跳转到支付页面

### 3. 支付功能测试

#### ✅ 访问支付页面
- [ ] 访问 `http://localhost:3000/payment`
- [ ] 检查页面是否正常显示
- [ ] 检查是否显示当前状态：
  - 会员状态：免费用户
  - 剩余免费次数：0 次
  - 总使用次数：3 次

#### ✅ 查看会员套餐
- [ ] 检查是否显示两个套餐：
  - 月度会员
  - 年度会员
- [ ] 检查套餐信息是否正确显示

#### ✅ 创建支付会话（测试）
- [ ] 点击"立即订阅 月度会员"按钮
- [ ] 检查是否创建支付会话成功
- [ ] 检查是否跳转到 Creem 支付页面
- [ ] **注意**：如果使用测试模式，可以使用测试卡号完成支付

### 4. Webhook 测试（需要 ngrok）

#### ✅ 配置 ngrok（如果还没配置）
- [ ] 启动 ngrok：`ngrok http 3000`
- [ ] 复制 ngrok URL（例如：`https://abc123.ngrok-free.app`）
- [ ] 在 Creem 后台更新 Webhook URL：
  ```
  https://abc123.ngrok-free.app/api/payment/webhook
  ```

#### ✅ 测试 Webhook
- [ ] 完成一次测试支付
- [ ] 访问 ngrok Web Interface：http://127.0.0.1:4040
- [ ] 检查是否收到 Webhook 请求
- [ ] 检查 Webhook 请求内容是否正确
- [ ] 检查数据库中用户会员状态是否已更新

#### ✅ 验证会员激活
- [ ] 支付成功后，返回应用
- [ ] 检查右上角是否显示"✓ 会员"
- [ ] 检查会员到期时间是否正确显示
- [ ] 再次点击"分析"，检查是否不扣除免费次数
- [ ] 检查会员用户可以无限次使用

### 5. 数据库验证

#### ✅ 检查 MongoDB Atlas
- [ ] 登录 MongoDB Atlas
- [ ] 进入 Data Explorer
- [ ] 检查 `skillcite` 数据库
- [ ] 检查 `users` 集合：
  - 是否有新注册的用户
  - `freeUsageCount` 是否正确
  - `isPremium` 是否正确
- [ ] 检查 `orders` 集合：
  - 是否有订单记录
  - 订单状态是否正确

### 6. 错误处理测试

#### ✅ 测试错误场景
- [ ] 尝试使用已注册的邮箱再次注册（应显示错误）
- [ ] 尝试使用错误的密码登录（应显示错误）
- [ ] 尝试在未登录时访问主页（应跳转到登录页）
- [ ] 尝试访问支付页面但未登录（应跳转到登录页）

## 🐛 常见问题排查

### 问题 1: 服务器无法启动
- 检查端口 3000 是否被占用
- 检查 `.env.local` 配置是否正确
- 检查 Prisma 客户端是否已生成：`npx prisma generate`

### 问题 2: 数据库连接失败
- 检查 `DATABASE_URL` 是否正确
- 检查 MongoDB Atlas 网络访问设置
- 检查数据库用户权限

### 问题 3: 支付功能不工作
- 检查 `CREEM_API_KEY` 是否正确
- 检查 `CREEM_API_BASE` 是否为测试环境 URL
- 检查产品 ID 是否正确
- 查看浏览器控制台和服务器日志

### 问题 4: Webhook 未触发
- 检查 ngrok 是否正在运行
- 检查 Creem 后台 Webhook URL 是否正确
- 检查 `CREEM_WEBHOOK_SECRET` 是否正确
- 访问 ngrok Web Interface 查看请求

## 📝 测试结果记录

### 测试日期：___________

### 测试人员：___________

### 测试结果：

- [ ] 所有功能正常
- [ ] 部分功能有问题（请记录问题）
- [ ] 无法测试（请说明原因）

### 发现的问题：

1. 
2. 
3. 

---

## 🎉 测试完成

如果所有测试都通过，恭喜！您的应用已经可以正常使用了！

下一步：
- [ ] 部署到生产环境
- [ ] 配置生产环境的 Creem API 密钥
- [ ] 更新生产环境的 Webhook URL
- [ ] 测试生产环境功能
